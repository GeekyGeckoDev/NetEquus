@page "/logout"
@using Application.UserApp.AuthServices
@using System.Security.Claims
@using UI.Services.Authentication
@rendermode InteractiveServer



<button @onclick="HandleLogout">Logout</button>

@code {
    [Inject] private IAuthService AuthService { get; set; }
    [Inject] private NavigationManager Navigation { get; set; }
    [Inject] private IJSRuntime JS { get; set; }

    private async Task HandleLogout()
    {
        // Clear Blazor state
        AuthService.CurrentUser = new System.Security.Claims.ClaimsPrincipal();
        AuthService.UserChanged += OnUserChanged;


        // Remove token from localStorage
        await JS.InvokeVoidAsync("localStorage.removeItem", "auth_token");


        // Sign out cookie
        if (AuthService is AuthService auth)
            await auth.SignOutCookieAsync();

        Console.WriteLine($"[Logout] User reset: {AuthService.CurrentUser.Identity?.Name ?? "Anonymous"}");

        // Navigate back to login or home
        Navigation.NavigateTo("/auth", forceLoad: true);
    }

        private ClaimsPrincipal user = new ClaimsPrincipal();

    private void OnUserChanged(ClaimsPrincipal updatedUser)
    {
        user = updatedUser;
        InvokeAsync(StateHasChanged);

        Console.WriteLine($"[Navbar] User updated: {user.Identity?.Name ?? "Anonymous"}");
    }
}