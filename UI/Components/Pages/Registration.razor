@page "/registration"

@using Application.UserApp.IUserServices
@using Application.UserApp.IUserServices.IUserValidationServices
@using Application.UserApp.UserDtos
@rendermode InteractiveServer

<h3>Register here</h3>

<div class="row">
    <div class="col">
        <div class="registration-box">

            <h2>Join NetEquus</h2>

            @if (!string.IsNullOrEmpty(usernameError))
            {
                <div class="text-danger">@usernameError</div>
            }
            <input placeholder="Enter your Username here"
                   class="input-style"
                   @bind="newUser.Username"
                   @onblur="@(async e => await CheckUsernameAsync())" />

            <input placeholder="Enter your email here"
                   class="input-style"
                   @bind="newUser.Email"
                   @onblur="@(async e => await CheckEmailAsync())" />

            @if (!string.IsNullOrEmpty(emailError))
            {
                <div class="text-danger">@emailError</div>
            }

            <input placeholder="Enter your password here"
                   type="password"
                   class="input-style"
                   @bind="newUser.Password" />

            @if (!string.IsNullOrEmpty(passwordError))
            {
                <div class="text-danger">@passwordError</div>
            }

            <br />

            <button class="button" @onclick="RegisterUserAsync">Register</button>

        </div>
    </div>
</div>

@code {

    [Inject] public IUserManagerService userManagerService { get; set; }
    [Inject] public IRegistrationValidationService registrationValidationService { get; set; }
    [Inject] public IEmailValidationService emailValidationService { get; set; }
    [Inject] public NavigationManager Navigation { get; set; }

    private UserRegistrationDto newUser = new UserRegistrationDto();

    private string usernameError;
    private string emailError;
    private string passwordError;


    private async Task CheckUsernameAsync()
    {
        if (string.IsNullOrWhiteSpace(newUser.Username) || newUser.Username.Length < 3)
        {
            usernameError = string.Empty;
            return;
        }

        var result = await registrationValidationService.CheckUsernameAsync(newUser.Username);
        usernameError = result.IsAllowed ? string.Empty : result.Message;
    }

    private async Task CheckEmailAsync()
    {
        if (string.IsNullOrWhiteSpace(newUser.Email))
        {
            emailError = "Email cannot be empty";
            return;
        }

        var result = await emailValidationService.CheckEmailAsync(newUser.Email);
        emailError = result.IsAllowed ? string.Empty : result.Message;
    }


    private async Task RegisterUserAsync()
    {
        if (!string.IsNullOrEmpty(usernameError) || !string.IsNullOrEmpty(emailError))
            return;

        var result = await userManagerService.HashAndCreateUserAsync(newUser);

        if (!result.IsAllowed)
        {
            if (result.Message.Contains("Password"))
                passwordError = result.Message;
            else
                usernameError = result.Message;

            return;
        }

        // Clear state
        newUser = new UserRegistrationDto();
        usernameError = emailError = passwordError = string.Empty;

        // Navigate user to login after successful registration
        Navigation.NavigateTo("/login");
    }
}